var App=App||{};App.Observer=(function(b){var a={};b.on=function(c,d){a[c]=a[c]||[];a[c].push(d)};b.off=function(d,f){if(a[d]){for(var e=0,c=a[d].length;e<c;e++){if(a[d][e]===f){a[d].splice(e,1)}}}};b.emit=function(c,d){if(a[c]){a[c].forEach(function(e){e(d)})}};return b})(App.Observer||{});App.Display=(function(i){var j={};var g={};a();f();function h(k){if(k){d("hp")}else{d("city")}}function b(o){var m=o.hp/o.maxHp;var l;var k;var n;var p;if(m>0.5){l="#0A0"}else{if(m>0.1){l="#A50"}else{l="#A00"}}if(o.type==="character"){k=g["character-hp-container"];n=g["character-hp-bar"];p=g["character-hp"]}else{k=g["mob-hp-container"];n=g["mob-hp-bar"];p=g["mob-hp"]}n.style.backgroundColor=l;n.style.width=m*k.offsetWidth+"px";p.innerHTML=o.hp+" / "+o.maxHp}function c(l){if(l.id){g[l.id]=l}for(var k=0,m=l.childNodes.length;k<m;k++){c(l.childNodes[k])}}function f(){g.adventure.addEventListener("click",function(){App.Observer.emit("buttonAdventureClicked")});App.Observer.on("zoneChanged",h);App.Observer.on("hpChanged",b)}function a(){var k=document.querySelectorAll('script[type="text/template"]');k.forEach(function(l){e(l)})}function e(l){if(j[l.id]!==undefined){return j[l.id]}else{var k=document.createElement("div");k.innerHTML=l.innerHTML;j[l.id]=k;c(k);return k}}function d(l){while(frame.firstChild){frame.removeChild(frame.firstChild)}var k=j[l];frame.appendChild(k)}return i})(App.Display||{});App.Game=(function(k){function d(o,p){this.name=o;this.stats={};this.initStats(p)}d.prototype.initStats=function(p){var o=this;b.stats.forEach(function(r){var q=p[r];var s=new g(q[0],q[1],q[2]);o.stats[r]=s})};function j(o){f.call(this,o);this.level=1;this.exp=0;this.currentZone=null}j.prototype=Object.create(f.prototype);j.prototype.constructor=j;j.prototype.moveTo=function(o){this.currentZone=o;console.log(this.archetype.name+" moves to "+o.name);App.Observer.emit("zoneChanged",o.fight);if(o.fight){setTimeout(this.fight.bind(this),1000)}else{this.recover()}};j.prototype.recover=function(){console.log(this.archetype.name+" recovers fully");var o=this;b.stats.forEach(function(p){o.stats[p].currentValue=o.stats[p].maxValue})};j.prototype.levelUp=function(){console.log(this.archetype.name+" levels up");var o=this;o.level++;o.exp=0;console.log(o.archetype.name+" is now level "+o.level);b.stats.forEach(function(q){var p=o.archetype.stats[q].getGrowth();o.stats[q].increaseMax(p)})};j.prototype.calcExp=function(o){var p=Math.ceil(o.expValue*o.level/this.level);return Math.min(p,100)};j.prototype.earnExp=function(o){console.log(this.archetype.name+" earns "+o+" exp");var q=100-this.exp;var p=Math.min(o,q);if(o<q){this.exp+=o}else{this.exp=100;this.levelUp();var r=o-q;this.exp=r}};var b={stats:["hp","atk","def"],characterArchetypes:[{name:"knight",stats:{hp:[1000,50,15],atk:[150,10,3],def:[120,8,2]}}],mobArchetypes:[{name:"orc",stats:{hp:[800,45,0],atk:[180,12,0],def:[40,5,0]}},{name:"goblin",stats:{hp:[500,20,0],atk:[130,7,0],def:[45,6,0]}}]};function f(o){this.archetype=o;this.stats={};this.initStats()}f.prototype.initStats=function(){var o=this;b.stats.forEach(function(q){var p=o.archetype.stats[q].baseValue;var r=new n(p);o.stats[q]=r})};f.prototype.attack=function(p){var o=this.stats.atk.currentValue-p.stats.def.currentValue;o=Math.max(o,0);p.receiveDamage(o)};f.prototype.receiveDamage=function(o){this.stats.hp.decrease(o)};f.prototype.isAlive=function(){return(this.stats.hp.currentValue>0)};j.prototype.fight=function(){var s=this;var o=s.currentZone.enemy;var q;var p;console.log(s.archetype.name+" starts fighting "+o.archetype.name);s.attack(o);p={hp:o.stats.hp.currentValue,maxHp:o.stats.hp.maxValue,type:"mob"};App.Observer.emit("hpChanged",p);if(!o.isAlive()){console.log("victory");var u=s.calcExp(o);s.earnExp(u);var r=s.currentZone.level+1;var t="the Road "+r;q=new m(t,r,true)}else{o.attack(s);p={hp:s.stats.hp.currentValue,maxHp:s.stats.hp.maxValue,type:"character"};App.Observer.emit("hpChanged",p);if(!s.isAlive()){console.log("defeat");q=e}}if(s.isAlive()&&o.isAlive()){setTimeout(s.fight.bind(s),1000)}else{s.moveTo(q)}};var i={};var a={};var h=null;var e=null;k.init=function(){b.characterArchetypes.forEach(function(o){var p=new d(o.name,o.stats);i[p.name]=p});b.mobArchetypes.forEach(function(o){var p=new d(o.name,o.stats);a[p.name]=p});h=new j(i.knight);e=new m("the City",0,false);h.moveTo(e);App.Observer.on("buttonAdventureClicked",c)};function c(){var o=new m("the Road",1,true);h.moveTo(o)}function l(o,p){this.level=p;f.call(this,o);this.expValue=this.calcExpValue()}l.prototype=Object.create(f.prototype);l.prototype.constructor=l;l.prototype.initStats=function(){var o=this;b.stats.forEach(function(q){var p=o.archetype.stats[q].baseValue;p+=o.archetype.stats[q].fixedGrowth*(o.level-1);var r=new n(p);o.stats[q]=r})};l.prototype.calcExpValue=function(){var o=this;var p=0;b.stats.forEach(function(q){p+=o.stats[q].maxValue});return Math.ceil(p/50)};function g(p,o,q){this.baseValue=p;this.fixedGrowth=o;this.variableGrowth=q}g.prototype.getGrowth=function(){var o=this.fixedGrowth+Math.round(Math.random()*this.variableGrowth);return o};function n(o){this.maxValue=o;this.currentValue=o}n.prototype.increaseMax=function(o){this.maxValue+=o;this.currentValue+=o};n.prototype.increase=function(o){var p=this.currentValue+o;this.currentValue=Math.min(p,this.maxValue)};n.prototype.decrease=function(o){var p=this.currentValue-o;this.currentValue=Math.max(p,0)};function m(o,q,p){this.name=o;this.level=q;this.fight=p;this.enemy=null;if(this.fight){this.summonEnemy()}}m.prototype.summonEnemy=function(){var o=Object.keys(a);var p=a[o[o.length*Math.random()<<0]];this.enemy=new l(p,this.level)};return k})(App.Game||{});