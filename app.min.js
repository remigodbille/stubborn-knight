var App=App||{};App.Observer=(function(b){var a={};b.on=function(c,d){a[c]=a[c]||[];a[c].push(d)};b.off=function(d,f){if(a[d]){for(var e=0,c=a[d].length;e<c;e++){if(a[d][e]===f){a[d].splice(e,1)}}}};b.emit=function(c,d){if(a[c]){a[c].forEach(function(e){e(d)})}};return b})(App.Observer||{});App.Display=(function(i){var j={};var k={};var g={};a();f();function h(l){if(l){d("hp")}else{d("city")}}function b(p){if(p.stat!=="hp"){return}var n=p.value/p.maxValue;var m;var l;var o;var q;if(n>0.5){m="#0A0"}else{if(n>0.1){m="#A50"}else{m="#A00"}}if(p.entity==="knight"){l=g["character-hp-container"];o=g["character-hp-bar"];q=g["character-hp"]}else{l=g["mob-hp-container"];o=g["mob-hp-bar"];q=g["mob-hp"]}o.style.backgroundColor=m;o.style.width=n*100+"px";var r=Mustache.render(q.template,p);q.innerHTML=r}function c(m){if(g[m.id]!==undefined){return}m.template=m.innerHTML;if(m.id){g[m.id]=m}for(var l=0,n=m.childNodes.length;l<n;l++){c(m.childNodes[l])}}function f(){g.adventure.addEventListener("click",function(){App.Observer.emit("buttonAdventureClicked")});App.Observer.on("zoneChanged",h);App.Observer.on("statChanged",b)}function a(){var l=document.querySelectorAll('script[type="text/template"]');l.forEach(function(m){e(m)})}function e(m){if(k[m.id]!==undefined){return k[m.id]}else{var l=document.createElement("div");l.innerHTML=m.innerHTML;k[m.id]=l;c(l);return l}}function d(m){while(frame.firstChild){frame.removeChild(frame.firstChild)}var l=k[m];frame.appendChild(l)}return i})(App.Display||{});App.Game=(function(k){function d(o,p){this.name=o;this.stats={};this.initStats(p)}d.prototype.initStats=function(p){var o=this;b.stats.forEach(function(r){var q=p[r];var s=new g(q[0],q[1],q[2]);o.stats[r]=s})};function j(p,q,o){f.call(this,p,q,o);this.exp=0;this.currentZone=null}j.prototype=Object.create(f.prototype);j.prototype.constructor=j;j.prototype.moveTo=function(o){this.currentZone=o;console.log(this.archetype.name+" moves to "+o.name);App.Observer.emit("zoneChanged",o.fight);if(o.fight){setTimeout(this.fight.bind(this),1000)}else{this.recover()}};j.prototype.recover=function(){console.log(this.archetype.name+" recovers fully");var o=this;b.stats.forEach(function(p){o.stats[p].toMax()})};j.prototype.levelUp=function(){self.exp=0;f.prototype.levelUp.call(this)};j.prototype.calcExp=function(o){var p=Math.ceil(o.expValue*o.level/this.level);return Math.min(p,100)};j.prototype.earnExp=function(o){console.log(this.archetype.name+" earns "+o+" exp");var q=100-this.exp;var p=Math.min(o,q);if(o<q){this.exp+=o}else{this.exp=100;this.levelUp();var r=o-q;this.exp=r}};var b={stats:["hp","atk","def"],characterArchetypes:[{name:"knight",stats:{hp:[1000,50,15],atk:[150,10,3],def:[120,8,2]}}],mobArchetypes:[{name:"orc",stats:{hp:[800,45,0],atk:[180,12,0],def:[40,5,0]}},{name:"goblin",stats:{hp:[500,20,0],atk:[130,7,0],def:[45,6,0]}}]};function f(p,q,o){this.archetype=p;this.level=q;this.stats={};this.name=o;this.initStats()}f.prototype.initStats=function(){var o=this;b.stats.forEach(function(s){var r=o.archetype.stats[s].baseValue;var t=new n(r,s,o.statChanged.bind(o));o.stats[s]=t});for(var p=1,q=o.level;p<q;p++){this.levelUp()}};f.prototype.statChanged=function(o){var p={entity:this.name,value:o.currentValue,maxValue:o.maxValue,stat:o.name};App.Observer.emit("statChanged",p)};f.prototype.levelUp=function(){var o=this;o.level++;b.stats.forEach(function(q){var p=o.archetype.stats[q].getGrowth();o.stats[q].increaseMax(p)})};f.prototype.attack=function(p){var o=this.stats.atk.currentValue-p.stats.def.currentValue;o=Math.max(o,0);p.receiveDamage(o)};f.prototype.receiveDamage=function(o){this.stats.hp.decrease(o)};f.prototype.isAlive=function(){return(this.stats.hp.currentValue>0)};j.prototype.fight=function(){var s=this;var o=s.currentZone.enemy;var q;var p;s.attack(o);if(!o.isAlive()){console.log("victory");var u=s.calcExp(o);s.earnExp(u);var r=s.currentZone.level+1;var t="the Road "+r;q=new m(t,r,true)}else{o.attack(s);if(!s.isAlive()){console.log("defeat");q=e}}if(s.isAlive()&&o.isAlive()){setTimeout(s.fight.bind(s),1000)}else{s.moveTo(q)}};var i={};var a={};var h=null;var e=null;k.init=function(){b.characterArchetypes.forEach(function(o){var p=new d(o.name,o.stats);i[p.name]=p});b.mobArchetypes.forEach(function(o){var p=new d(o.name,o.stats);a[p.name]=p});h=new j(i.knight,1,"knight");e=new m("the City",0,false);h.moveTo(e);App.Observer.on("buttonAdventureClicked",c)};function c(){var o=new m("the Road",1,true);h.moveTo(o)}function l(p,q,o){f.call(this,p,q,o);this.expValue=this.calcExpValue()}l.prototype=Object.create(f.prototype);l.prototype.constructor=l;l.prototype.calcExpValue=function(){var o=this;var p=0;b.stats.forEach(function(q){p+=o.stats[q].maxValue});return Math.ceil(p/50)};function g(p,o,q){this.baseValue=p;this.fixedGrowth=o;this.variableGrowth=q}g.prototype.getGrowth=function(){var o=this.fixedGrowth+Math.round(Math.random()*this.variableGrowth);return o};function n(p,o,q){this.name=o;this.callback=q;this.maxValue=p;this.setValue(p)}n.prototype.increaseMax=function(o){this.maxValue+=o;this.setValue(this.currentValue+o)};n.prototype.increase=function(o){var p=this.currentValue+o;this.setValue(Math.min(p,this.maxValue))};n.prototype.decrease=function(o){var p=this.currentValue-o;this.setValue(Math.max(p,0))};n.prototype.toMax=function(){this.setValue(this.maxValue)};n.prototype.toZero=function(){this.setValue(0)};n.prototype.setValue=function(o){this.currentValue=o;this.callback(this)};function m(o,q,p){this.name=o;this.level=q;this.fight=p;this.enemy=null;if(this.fight){this.summonEnemy()}}m.prototype.summonEnemy=function(){var o=Object.keys(a);var p=a[o[o.length*Math.random()<<0]];this.enemy=new l(p,this.level,p.name)};return k})(App.Game||{});